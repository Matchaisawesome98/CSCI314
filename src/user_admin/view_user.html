<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Admin Dashboard</title>
    <style>
        .blur-text { 
        filter: blur(4px); 
        user-select: none; 
        }
        .blur-text:hover { 
        filter: blur(0); 
        }
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { margin: 20px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f5f5f5; }
        .search-container { margin: 20px 0; }
        .search-container input { padding: 8px; width: 300px; margin-right: 10px; }
        .search-container button { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        .search-container button:hover { background-color: #45a049; }
    </style>
</head>
<body>
<h1>User Admin Dashboard</h1>
<button id="viewAllButton" onclick="initViewUsers()">View All Users</button>
<div id="searchContainer" class="search-container" style="display: none;">
    <input type="text" id="searchInput" placeholder="Enter user name to search..." onkeydown="handleSearchKeyPress(event)">
    <button onclick="performSearch()">Search</button>
</div>
<div id="status" class="status" style="display: none;"></div>
<div id="tableContainer"></div>

<script>



class User_Admin_Entity {
    async fetchAllUsers() {
        try {
            const response = await fetch('http://localhost:3000/get-homeowners');
            
            // Check if the response is OK
            if (!response.ok) {
                // Handle HTTP error responses (4xx, 5xx)
                const errorData = await response.json().catch(() => ({}));
                return {
                    success: false,
                    message: errorData.message || `Server error: ${response.status} ${response.statusText}`
                };
            }
            
            const data = await response.json();
            // If data is not an array, wrap it in an array to maintain consistency
            const normalizedData = Array.isArray(data) ? data : (data.data ? data.data : []);
            
            return {
                success: true,
                data: normalizedData
            };
        } catch (error) {
            // Handle network errors, CORS issues, or other connection problems
            return {
                success: false,
                message: `Server connection error: ${error.message}`
            };
        }
    }
}








// Controller class - Handles business logic and passes data between entity and UI
class ViewController {
    constructor() {
        this.viewEntity = new User_Admin_Entity();
    }
    
    async getAllUsers() {
        // Simply pass through to the entity
        return await this.viewEntity.fetchAllUsers();
    }
}

// UI class - Handles presentation and UI-related exception handling
class ViewUI {
    constructor() {
        this.controller = new ViewController();
        this.statusDiv = document.getElementById('status');
        this.tableContainer = document.getElementById('tableContainer');
    }
    
    showLoading() {
        try {
            this.statusDiv.style.display = 'block';
            this.statusDiv.innerHTML = 'Fetching data...';
            this.statusDiv.className = 'status';
            this.tableContainer.innerHTML = '';
        } catch (error) {
            console.error('UI Error in showLoading:', error);
            // Handle UI-specific errors
            this.handleUIError(error);
        }
    }
    
    showError(message) {
        try {
            this.statusDiv.className = 'status error';
            this.statusDiv.innerHTML = `Error: ${message}`;
        } catch (error) {
            console.error('UI Error in showError:', error);
            // Handle UI-specific errors
            this.handleUIError(error);
        }
    }
    
    showSuccess(count) {
        try {
            this.statusDiv.className = 'status success';
            this.statusDiv.innerHTML = `Found ${count} records`;
        } catch (error) {
            console.error('UI Error in showSuccess:', error);
            // Handle UI-specific errors
            this.handleUIError(error);
        }
    }
    
    handleUIError(error) {
        // Method to handle UI-specific errors (syntax errors, DOM manipulation errors)
        try {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'ui-error';
            errorDiv.innerHTML = `UI Error: ${error.message}`;
            document.body.appendChild(errorDiv);
        } catch (e) {
            // Last resort error handling
            alert(`Critical UI error: ${error.message}`);
        }
    }
    
    renderTable(data) {
        try {
            // Ensure data is an array to prevent undefined errors
            const safeData = Array.isArray(data) ? data : [];
            
            if (safeData.length === 0) {
                this.tableContainer.innerHTML = '<p>No records found in the table.</p>';
                return;
            }
            
            // Create table
            let tableHTML = '<table><thead><tr>';
            
            // Get column names from the first record
            const columns = Object.keys(safeData[0]);
            
            // Add table headers
            columns.forEach(column => {
                tableHTML += `<th>${column}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // Add table rows
            safeData.forEach(row => {
                tableHTML += '<tr>';
                columns.forEach(column => {
                    // Special handling for password column - blur it
                    if (column === 'password') {
                        tableHTML += `<td><span class="blur-text">${row[column] || ''}</span></td>`;
                    }
                    // Special handling for the isSuspended column to show true/false explicitly
                    else if (column === 'isSuspended') {
                        tableHTML += `<td>${row[column] ? 'true' : 'false'}</td>`;
                    }
                    else {
                        tableHTML += `<td>${row[column] || ''}</td>`;
                    }
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            this.tableContainer.innerHTML = tableHTML;
        } catch (error) {
            console.error('UI Error in renderTable:', error);
            // Handle UI-specific errors
            this.handleUIError(error);
        }
    }
    
    async displayAllUsers() {
        this.showLoading();
        
        try {
            const result = await this.controller.getAllUsers();
            
            if (!result.success) {
                // Handle API error response from entity
                this.showError(result.message || 'Unknown error occurred');
                return;
            }
            
            // Make sure data is defined before accessing its length
            const userData = result.data || [];
            this.showSuccess(userData.length);
            this.renderTable(userData);
        } catch (error) {
            // Handle unexpected UI errors
            console.error('Unexpected UI Error:', error);
            this.showError(`UI error: ${error.message}`);
        }
    }
}

// --- SEARCH FEATURE ---
// Search Controller class
class SearchController {
    constructor() {
        this.searchEntity = new User_Admin_Entity();
    }
    
    async getAllUsers() {
        // Pass through to entity
        return await this.searchEntity.fetchAllUsers();
    }
    
    async searchUsers(searchTerm) {
        // If search term is empty, return all users
        if (!searchTerm || searchTerm.trim() === '') {
            return await this.getAllUsers();
        }
        
        // Get all users first
        const result = await this.searchEntity.fetchAllUsers();
        
        // If there was an error, just pass it through
        if (!result.success) {
            return result;
        }
        
        // Filter users based on search term - business logic in controller
        try {
            // Ensure data is an array to prevent undefined errors
            const safeData = Array.isArray(result.data) ? result.data : [];
            
            const filteredData = safeData.filter(user => {
                return Object.values(user).some(value => 
                    value !== null && 
                    value !== undefined && 
                    String(value).toLowerCase().includes(searchTerm.toLowerCase())
                );
            });
            
            // Return the filtered data
            return {
                success: true,
                data: filteredData
            };
        } catch (error) {
            // Handle any errors during filtering (not server errors)
            return {
                success: false,
                message: `Error processing search: ${error.message}`
            };
        }
    }
}

// Search UI class
class SearchUI {
    constructor() {
        this.controller = new SearchController();
        this.statusDiv = document.getElementById('status');
        this.tableContainer = document.getElementById('tableContainer');
        this.searchInput = document.getElementById('searchInput');
    }
    
    showLoading() {
        try {
            this.statusDiv.style.display = 'block';
            this.statusDiv.innerHTML = 'Searching...';
            this.statusDiv.className = 'status';
            this.tableContainer.innerHTML = '';
        } catch (error) {
            console.error('UI Error in showLoading:', error);
            this.handleUIError(error);
        }
    }
    
    showError(message) {
        try {
            this.statusDiv.className = 'status error';
            this.statusDiv.innerHTML = `Error: ${message}`;
        } catch (error) {
            console.error('UI Error in showError:', error);
            this.handleUIError(error);
        }
    }
    
    showSuccess(count) {
        try {
            this.statusDiv.className = 'status success';
            this.statusDiv.innerHTML = `Found ${count} matching users`;
        } catch (error) {
            console.error('UI Error in showSuccess:', error);
            this.handleUIError(error);
        }
    }
    
    handleUIError(error) {
        // Method to handle UI-specific errors
        try {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'ui-error';
            errorDiv.innerHTML = `UI Error: ${error.message}`;
            document.body.appendChild(errorDiv);
        } catch (e) {
            // Last resort error handling
            alert(`Critical UI error: ${error.message}`);
        }
    }
    
    renderSearchResults(data) {
        try {
            // Ensure data is an array to prevent undefined errors
            const safeData = Array.isArray(data) ? data : [];
            
            if (safeData.length === 0) {
                this.tableContainer.innerHTML = '<p>No users found matching your search.</p>';
                return;
            }
            
            // Create table
            let tableHTML = '<table><thead><tr>';
            
            // Get column names from the first record
            const columns = Object.keys(safeData[0]);
            
            // Add table headers
            columns.forEach(column => {
                tableHTML += `<th>${column}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // Add table rows
            safeData.forEach(row => {
                tableHTML += '<tr>';
                columns.forEach(column => {
                    // Special handling for password column - blur it
                    if (column === 'password') {
                        tableHTML += `<td><span class="blur-text">${row[column] || ''}</span></td>`;
                    }
                    // Special handling for the isSuspended column
                    else if (column === 'isSuspended') {
                        tableHTML += `<td>${row[column] ? 'true' : 'false'}</td>`;
                    }
                    else {
                        tableHTML += `<td>${row[column] || ''}</td>`;
                    }
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            this.tableContainer.innerHTML = tableHTML;
        } catch (error) {
            console.error('UI Error in renderSearchResults:', error);
            this.handleUIError(error);
        }
    }
    
    async performSearch() {
        try {
            const searchTerm = this.searchInput.value.trim();
            this.showLoading();
            
            const result = await this.controller.searchUsers(searchTerm);
            
            if (!result.success) {
                // Handle API error response
                this.showError(result.message || 'Unknown error occurred');
                return;
            }
            
            // Make sure data is defined before accessing its length
            const userData = result.data || [];
            this.showSuccess(userData.length);
            this.renderSearchResults(userData);
        } catch (error) {
            // Handle UI-specific errors
            console.error('UI Error in performSearch:', error);
            this.showError(`UI error: ${error.message}`);
        }
    }
}

// Initialize the UI instances
let viewUI;
let searchUI;

// View users initialization function
function initViewUsers() {
    try {
        // Hide the View All button
        document.getElementById('viewAllButton').style.display = 'none';
        // Show the search container
        document.getElementById('searchContainer').style.display = 'block';
        
        // Initialize the view UI if not already done
        if (!viewUI) {
            viewUI = new ViewUI();
        }
        
        // Display all users
        viewUI.displayAllUsers();
    } catch (error) {
        console.error('Error initializing view:', error);
        alert(`Failed to initialize view: ${error.message}`);
    }
}

// Search function
function performSearch() {
    try {
        // Initialize the search UI if not already done
        if (!searchUI) {
            searchUI = new SearchUI();
        }
        
        // Perform search
        searchUI.performSearch();
    } catch (error) {
        console.error('Error performing search:', error);
        alert(`Failed to perform search: ${error.message}`);
    }
}

// Handle keyboard events for search input
function handleSearchKeyPress(event) {
    try {
        // Check if Enter key was pressed
        if (event.key === 'Enter') {
            event.preventDefault();
            performSearch();
        }
    } catch (error) {
        console.error('Error handling key press:', error);
        alert(`Error in search key handling: ${error.message}`);
    }
}



















    
    
</script>

</body>
</html>