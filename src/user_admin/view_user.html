<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Admin Dashboard</title>
    <style>
        .blur-text { 
        filter: blur(4px); 
        user-select: none; 
        }
        .blur-text:hover { 
        filter: blur(0); 
        }
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { margin: 20px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f5f5f5; }
        .search-container { margin: 20px 0; }
        .search-container input { padding: 8px; width: 300px; margin-right: 10px; }
        .search-container button { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        .search-container button:hover { background-color: #45a049; }
    </style>
</head>
<body>
<h1>User Admin Dashboard</h1>
<button id="viewAllButton" onclick="initViewUsers()">View All Users</button>
<div id="searchContainer" class="search-container" style="display: none;">
    <input type="text" id="searchInput" placeholder="Enter user name to search..." onkeydown="handleSearchKeyPress(event)">
    <button onclick="performSearch()">Search</button>
</div>
<div id="status" class="status" style="display: none;"></div>
<div id="tableContainer"></div>

<script>
    // --- VIEW USERS FEATURE ---
    
    // Entity class - Handles data operations
    class ViewEntity {
        async fetchAllUsers() {
            const response = await fetch('http://localhost:3000/get-homeowners');
            const data = await response.json();
            return data;
        }
    }
    
    // Controller class - Handles business logic
    class ViewController {
        constructor() {
            this.viewEntity = new ViewEntity();
        }
        
        async getAllUsers() {
            try {
                const result = await this.viewEntity.fetchAllUsers();
                return result;
            } catch (error) {
                return { 
                    success: false, 
                    message: `Error fetching users: ${error.message}` 
                };
            }
        }
        
        // processUserData(userData) {
        //     return userData;
        // }
    }
    
    // UI class - Handles presentation
    class ViewUI {
        constructor() {
            this.controller = new ViewController();
            this.statusDiv = document.getElementById('status');
            this.tableContainer = document.getElementById('tableContainer');
        }
        
        showLoading() {
            this.statusDiv.style.display = 'block';
            this.statusDiv.innerHTML = 'Fetching data...';
            this.statusDiv.className = 'status';
            this.tableContainer.innerHTML = '';
        }
        
        showError(message) {
            this.statusDiv.className = 'status error';
            this.statusDiv.innerHTML = `Error: ${message}`;
        }
        
        showSuccess(count) {
            this.statusDiv.className = 'status success';
            this.statusDiv.innerHTML = `Found ${count} records`;
        }
        
        renderTable(data) {
            if (data.length === 0) {
                this.tableContainer.innerHTML = '<p>No records found in the table.</p>';
                return;
            }
            
            // Create table
            let tableHTML = '<table><thead><tr>';
            
            // Get column names from the first record
            const columns = Object.keys(data[0]);
            
            // Add table headers
            columns.forEach(column => {
                tableHTML += `<th>${column}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // Add table rows
            data.forEach(row => {
                tableHTML += '<tr>';
                columns.forEach(column => {
                    // Special handling for password column - blur it
                    if (column === 'password') {
                        tableHTML += `<td><span class="blur-text">${row[column] || ''}</span></td>`;
                    }
                    // Special handling for the isSuspended column to show true/false explicitly
                    else if (column === 'isSuspended') {
                        tableHTML += `<td>${row[column] ? 'true' : 'false'}</td>`;
                    }
                    else {
                        tableHTML += `<td>${row[column] || ''}</td>`;
                    }
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            this.tableContainer.innerHTML = tableHTML;
        }
        
        async displayAllUsers() {
            this.showLoading();
            
            try {
                const result = await this.controller.getAllUsers();
                
                if (result.success) {
                    this.showSuccess(result.data.length);
                    // const processedData = this.controller.processUserData(result.data);
                    this.renderTable(result.data);
                } else {
                    this.showError(result.message);
                }
            } catch (error) {
                this.showError(`Failed to connect to server: ${error.message}`);
            }
        }
    }
    
    // --- SEARCH FEATURE ---
    
    // Entity class - Handles data operations
    class SearchEntity {
        async fetchUsers() {
            const response = await fetch('http://localhost:3000/get-homeowners');
            const data = await response.json();
            return data;
        }
    }
    
    // Controller class - Handles business logic
    class SearchController {
        constructor() {
            this.searchEntity = new SearchEntity();
        }
        
        async getAllUsers() {
            try {
                const result = await this.searchEntity.fetchUsers();
                return result;
            } catch (error) {
                return { 
                    success: false, 
                    message: `Error fetching users: ${error.message}` 
                };
            }
        }
        
        async searchUsers(searchTerm) {
            // If search term is empty, return all users instead of an error
            if (!searchTerm || searchTerm.trim() === '') {
                return this.getAllUsers();
            }
            
            try {
                const result = await this.searchEntity.fetchUsers();
                
                if (result.success) {
                    // Filter users based on search term
                    const filteredData = result.data.filter(user => {
                        return Object.values(user).some(value => 
                            typeof value === 'string' && 
                            value.toLowerCase().includes(searchTerm.toLowerCase())
                        );
                    });
                    
                    return {
                        success: true,
                        data: filteredData
                    };
                } else {
                    return result; // Pass along the error
                }
            } catch (error) {
                return { 
                    success: false, 
                    message: `Error searching users: ${error.message}` 
                };
            }
        }
    }
    
    // UI class - Handles presentation
    class SearchUI {
        constructor() {
            this.controller = new SearchController();
            this.statusDiv = document.getElementById('status');
            this.tableContainer = document.getElementById('tableContainer');
            this.searchInput = document.getElementById('searchInput');
        }
        
        showLoading() {
            this.statusDiv.style.display = 'block';
            this.statusDiv.innerHTML = 'Searching...';
            this.statusDiv.className = 'status';
            this.tableContainer.innerHTML = '';
        }
        
        showError(message) {
            this.statusDiv.className = 'status error';
            this.statusDiv.innerHTML = `Error: ${message}`;
        }
        
        showSuccess(count) {
            this.statusDiv.className = 'status success';
            this.statusDiv.innerHTML = `Found ${count} matching users`;
        }
        
        renderSearchResults(data) {
            if (data.length === 0) {
                this.tableContainer.innerHTML = '<p>No users found matching your search.</p>';
                return;
            }
            
            // Create table
            let tableHTML = '<table><thead><tr>';
            
            // Get column names from the first record
            const columns = Object.keys(data[0]);
            
            // Add table headers
            columns.forEach(column => {
                tableHTML += `<th>${column}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // Add table rows
            data.forEach(row => {
                tableHTML += '<tr>';
                columns.forEach(column => {
                    // Special handling for password column - blur it
                    if (column === 'password') {
                        tableHTML += `<td><span class="blur-text">${row[column] || ''}</span></td>`;
                    }
                    // Special handling for the isSuspended column
                    else if (column === 'isSuspended') {
                        tableHTML += `<td>${row[column] ? 'true' : 'false'}</td>`;
                    }
                    else {
                        tableHTML += `<td>${row[column] || ''}</td>`;
                    }
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            this.tableContainer.innerHTML = tableHTML;
        }
        
        async performSearch() {
            const searchTerm = this.searchInput.value.trim();
            
            this.showLoading();
            
            try {
                const result = await this.controller.searchUsers(searchTerm);
                
                if (result.success) {
                    this.showSuccess(result.data.length);
                    this.renderSearchResults(result.data);
                } else {
                    this.showError(result.message);
                }
            } catch (error) {
                this.showError(`Failed to connect to server: ${error.message}`);
            }
        }
    }
    
    // Initialize the UI instances
    let viewUI;
    let searchUI;
    
    // View users initialization function
    function initViewUsers() {
        // Hide the View All button
        document.getElementById('viewAllButton').style.display = 'none';
        // Show the search container
        document.getElementById('searchContainer').style.display = 'block';
        
        // Initialize the view UI if not already done
        if (!viewUI) {
            viewUI = new ViewUI();
        }
        
        // Display all users
        viewUI.displayAllUsers();
    }
    
    // Search function
    function performSearch() {
        // Initialize the search UI if not already done
        if (!searchUI) {
            searchUI = new SearchUI();
        }
        
        // Perform search
        searchUI.performSearch();
    }
    
    // Handle keyboard events for search input
    function handleSearchKeyPress(event) {
        // Check if Enter key was pressed
        if (event.key === 'Enter') {
            event.preventDefault();
            performSearch();
        }
    }
</script>

</body>
</html>